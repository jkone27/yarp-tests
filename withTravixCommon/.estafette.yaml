# https://estafette.io/usage/manifest/#labels
labels:
  app: testweb
  team: test
  language: dotnet-core

# https://estafette.io/usage/manifest/#build-stages
stages:
  # https://github.com/estafette/estafette-extension-dotnet
  restore:
    image: extensions/dotnet:5.0-stable
    action: restore

  build:
    image: extensions/dotnet:5.0-stable
    action: build

  unit-tests:
    image: extensions/dotnet:5.0-stable
    action: unit-test

  integration-tests:
    image: extensions/dotnet:5.0-stable
    action: integration-test

  publish:
    image: extensions/dotnet:5.0-stable
    action: publish

  sonarqube:
    image: extensions/dotnet:5.0-stable
    action: analyze-sonarqube

  # https://estafette.io/usage/extensions/estafette-extensions/#extensions-docker
  bake:
    image: extensions/docker:stable
    action: build
    path: ./publish
    repositories:
    - eu.gcr.io/travix-com

  push-to-gcr-io:
    image: extensions/docker:stable
    action: push
    repositories:
    - eu.gcr.io/travix-com

# https://estafette.io/usage/manifest/#releases
releases:
  development:
    stages:
      deploy:
        image: extensions/gke:stable
        visibility: private
        container:
          port: 5000
          metrics:
            port: 9090
          env:
            ASPNETCORE_ENVIRONMENT: "Development"
            Foo: "Dev value"
        hosts:
        - testweb.development.travix.com

  staging:
    stages:
      deploy:
        image: extensions/gke:stable
        visibility: private
        container:
          port: 5000
          metrics:
            port: 9090
          env:
            ASPNETCORE_ENVIRONMENT: "Staging"
            Foo: "Staging value"
        hosts:
        - testweb.staging.travix.com

  production:
    actions:
    - name: deploy-canary
    - name: deploy-stable
    - name: rollback-canary
    stages:
      deploy:
        image: extensions/gke:stable
        visibility: private
        container:
          port: 5000
          metrics:
            port: 9090
          env:
            ASPNETCORE_ENVIRONMENT: "Production"
            Foo: "Prod value"
        hosts:
        - testweb.travix.com
